<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot con Bloques - Versi√≥n Mejorada</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Comic Sans MS', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 4px;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            height: calc(100vh - 8px);
            display: flex;
            flex-direction: column;
        }
        .header {
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            color: white;
            padding: 6px 10px;
            text-align: center;
        }
        .header h1 { font-size: 1.2em; margin-bottom: 3px; }
        .header p { font-size: 0.85em; opacity: 0.9; }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .blocks-panel {
            width: 160px;
            background: #f0f8ff;
            border-right: 2px solid #4CAF50;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .panel-title {
            background: #4CAF50;
            color: white;
            padding: 8px;
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
        }
        .blocks-category {
            padding: 6px;
        }
        .category-title {
            font-size: 0.75em;
            font-weight: bold;
            color: #333;
            margin: 6px 0 4px 0;
            padding: 3px;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
        }
        
        .block-palette {
            background: white;
            border: 2px solid;
            border-radius: 6px;
            padding: 4px 5px;
            margin: 3px 0;
            cursor: grab;
            font-weight: bold;
            font-size: 9px;
            transition: transform 0.2s;
            user-select: none;
        }
        .block-palette:hover {
        }
        .block-palette:active {
            cursor: grabbing;
        }
        
        .block-move { border-color: #2196F3; background: #E3F2FD; color: #1976D2; }
        .block-turn { border-color: #9C27B0; background: #F3E5F5; color: #7B1FA2; }
        .block-paint { border-color: #FF9800; background: #FFF3E0; color: #F57C00; }
        .block-control { border-color: #4CAF50; background: #E8F5E9; color: #388E3C; }
        .block-conditional { border-color: #FF5722; background: #FBE9E7; color: #D84315; }
        .block-end { border-color: #607D8B; background: #ECEFF1; color: #455A64; }
        
        .workspace-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }
        
        .controls {
            background: white;
            padding: 5px;
            border-bottom: 2px solid #ddd;
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
            transition: all 0.3s;
            color: white;
        }
        .control-btn.run { background: linear-gradient(45deg, #4CAF50, #66BB6A); }
        .control-btn.step { background: linear-gradient(45deg, #FF9800, #FFB74D); }
        .control-btn.reset { background: linear-gradient(45deg, #2196F3, #64B5F6); }
        .control-btn.clear { background: linear-gradient(45deg, #f44336, #e57373); }
        .control-btn.challenges { background: linear-gradient(45deg, #9C27B0, #BA68C8); }
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }
        .speed-control label {
            font-size: 10px;
            font-weight: 600;
        }
        #speedSlider {
            width: 100px;
        }
        
        .examples-bar {
            background: white;
            padding: 6px 8px;
            border-bottom: 2px solid #ddd;
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }
        .example-label {
            font-weight: bold;
            font-size: 11px;
            color: #333;
        }
        .example-btn, #mapSelector {
            padding: 4px 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .example-btn:hover {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .construction-tools {
            background: #fff3cd;
            padding: 6px 8px;
            border-bottom: 2px solid #ffc107;
            display: none;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }
        .tool-btn {
            padding: 4px 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
        }
        .tool-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .workspace-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .canvas-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-right: 2px solid #ddd;
            padding: 5px;
        }
        
        #robotCanvas {
            border: 3px solid #4CAF50;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        
        .assembly-area {
            flex: 1;
            background: #fafafa;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px 12px 80px 12px;
            border-left: 2px solid #ddd;
            min-height: 0;
        }
        
        .assembly-area::-webkit-scrollbar {
            width: 12px;
        }
        
        .assembly-area::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        
        .assembly-area::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 6px;
        }
        
        .assembly-area::-webkit-scrollbar-thumb:hover {
            background: #45a049;
        }
        
        .assembly-title {
            background: #4CAF50;
            color: white;
            padding: 6px 8px;
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            margin-bottom: 10px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .block-assembled {
            background: white;
            border: 2px solid;
            border-radius: 6px;
            padding: 8px 10px;
            margin: 5px 0;
            font-weight: bold;
            font-size: 11px;
            cursor: move;
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: margin-left 0.3s;
        }
        
        .block-assembled.executing {
            background: #FFF9C4;
            box-shadow: 0 0 10px rgba(255, 235, 59, 0.8);
        }
        
        .block-assembled.indent-1 {
            margin-left: 20px;
        }
        
        .block-assembled.indent-2 {
            margin-left: 40px;
        }
        
        .block-assembled.indent-3 {
            margin-left: 60px;
        }
        
        .block-delete {
            position: absolute;
            right: 6px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 14px;
            line-height: 18px;
            text-align: center;
        }
        
        .block-input {
            width: 40px;
            padding: 2px 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            text-align: center;
        }
        
        .block-select {
            padding: 2px 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            background: white;
        }
        
        .console-container {
            background: #f0f0f0;
            color: #333;
            padding: 5px;
            height: 30px;
            overflow: hidden;
            font-family: 'Comic Sans MS', sans-serif;
            font-size: 14px;
            font-weight: bold;
            border-top: 2px solid #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .console-line {
            margin: 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }

        .modal-header h2 {
            color: #4CAF50;
            font-size: 1.5em;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .challenges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .challenge-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .challenge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .challenge-card.completed {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
        }

        .challenge-card.completed::after {
            content: "‚úÖ";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
        }

        .challenge-card h3 {
            font-size: 1em;
            margin-bottom: 8px;
        }

        .challenge-card p {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .challenge-difficulty {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-top: 8px;
            background: rgba(255,255,255,0.2);
        }
        
        .message-overlay {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 80px;
            border-radius: 20px;
            font-size: 3em;
            font-weight: bold;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: popIn 0.3s ease-out;
        }
        
        .message-overlay.success {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
        }
        
        .message-overlay.error {
            background: linear-gradient(135deg, #f44336 0%, #e57373 100%);
        }
        
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .challenge-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
        }

        .challenge-info h3 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .challenge-info p {
            margin: 5px 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Robot Programable</h1>
            <p>Aprende programaci√≥n con bloques visuales - Versi√≥n Mejorada</p>
        </div>
        
        <div class="main-content">
            <div class="blocks-panel">
                <div class="panel-title">üß© BLOQUES</div>
                <div class="blocks-category">
                    <div class="category-title">‚¨ÜÔ∏è Movimiento</div>
                    <div class="block-palette block-move" draggable="true" data-type="AVANZAR">
                        ‚¨ÜÔ∏è AVANZAR
                    </div>
                    <div class="block-palette block-move" draggable="true" data-type="RETROCEDER">
                        ‚¨áÔ∏è RETROCEDER
                    </div>
                </div>
                
                <div class="blocks-category">
                    <div class="category-title">‚Ü©Ô∏è Giros</div>
                    <div class="block-palette block-turn" draggable="true" data-type="GIRAR_DERECHA">
                        ‚Ü™Ô∏è GIRAR ‚Üí
                    </div>
                    <div class="block-palette block-turn" draggable="true" data-type="GIRAR_IZQUIERDA">
                        ‚Ü©Ô∏è GIRAR ‚Üê
                    </div>
                </div>
                
                <div class="blocks-category">
                    <div class="category-title">üé® Pintar</div>
                    <div class="block-palette block-paint" draggable="true" data-type="PINTAR">
                        üé® PINTAR
                    </div>
                    <div class="block-palette block-paint" draggable="true" data-type="NO_PINTAR">
                        üö´ NO PINTAR
                    </div>
                </div>
                
                <div class="blocks-category">
                    <div class="category-title">üîÅ Control</div>
                    <div class="block-palette block-control" draggable="true" data-type="REPETIR">
                        üîÅ REPETIR
                    </div>
                    <div class="block-palette block-end" draggable="true" data-type="FIN_REPETIR">
                        üîö FIN REPETIR
                    </div>
                </div>
                
                <div class="blocks-category">
                    <div class="category-title">‚ùì Condicionales</div>
                    <div class="block-palette block-conditional" draggable="true" data-type="SI">
                        ‚ùì SI
                    </div>
                    <div class="block-palette block-end" draggable="true" data-type="FIN_SI">
                        üîö FIN SI
                    </div>
                </div>
            </div>
            
            <div class="workspace-area">
                <div class="controls">
                    <button class="control-btn run" onclick="runProgram()">‚ñ∂Ô∏è Ejecutar</button>
                    <button class="control-btn step" onclick="stepProgram()">‚èØÔ∏è Paso a Paso</button>
                    <button class="control-btn step" onclick="nextStep()" id="nextStepBtn" disabled>‚è≠Ô∏è Siguiente</button>
                    <button class="control-btn reset" onclick="resetRobot()">üîÑ Reiniciar</button>
                    <button class="control-btn clear" onclick="clearProgram()">üóëÔ∏è Limpiar</button>
                    <button class="control-btn challenges" onclick="openChallengesModal()">üéØ Retos</button>
                    
                    <div style="flex: 1;"></div>
                    
                    <div class="speed-control">
                        <label>Velocidad:</label>
                        <input type="range" id="speedSlider" min="1" max="10" value="5">
                        <span id="speedValue">5</span>
                    </div>
                </div>
                
                <div class="examples-bar">
                    <span class="example-label">üìö Ejemplos:</span>
                    <button class="example-btn" onclick="loadExample('cuadrado')">Cuadrado</button>
                    <button class="example-btn" onclick="loadExample('linea')">L√≠nea</button>
                    
                    <span class="example-label" style="margin-left: 20px;">üó∫Ô∏è Mapas:</span>
                    <select id="mapSelector" onchange="loadMap(this)">
                        <option value="">Seleccionar...</option>
                        <option value="map1">L√≠nea Recta</option>
                        <option value="map2">Esquina Simple</option>
                        <option value="map3">Zigzag</option>
                        <option value="map4">Corredor</option>
                        <option value="map5">L Simple</option>
                    </select>
                    
                    <button class="example-btn" onclick="toggleConstruction()" style="margin-left: 20px;">üèóÔ∏è Constructor</button>
                    <button class="example-btn" onclick="saveProject()">üíæ Guardar</button>
                    <label class="example-btn" style="cursor: pointer;">
                        üìÇ Abrir
                        <input type="file" accept=".json" onchange="loadProject(event)" style="display: none;">
                    </label>
                </div>
                
                <div class="construction-tools" id="constructionTools">
                    <span class="example-label">üèóÔ∏è Herramientas:</span>
                    <button class="tool-btn" onclick="setTool('wall')">üß± Muro</button>
                    <button class="tool-btn" onclick="setTool('erase')">üßπ Borrar</button>
                    <button class="tool-btn" onclick="setTool('start')">üìç Inicio</button>
                    <button class="tool-btn" onclick="setTool('goal')">üéØ Meta</button>
                    <button class="example-btn" onclick="clearMap()">üóëÔ∏è Limpiar Mapa</button>
                </div>
                
                <div class="workspace-container">
                    <div class="canvas-container">
                        <canvas id="robotCanvas" width="1050" height="600"></canvas>
                    </div>
                    
                    <div class="assembly-area" id="workspace">
                        <div class="assembly-title">üìù MI PROGRAMA</div>
                    </div>
                </div>
                
                <div class="console-container" id="console">
                    <div class="console-line"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="challengesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üéØ Retos de Programaci√≥n</h2>
                <span class="close" onclick="closeChallengesModal()">&times;</span>
            </div>
            
            <div class="challenge-info">
                <h3>¬øC√≥mo funcionan los retos?</h3>
                <p>üìù Cada reto tiene un objetivo espec√≠fico que debes lograr programando el robot.</p>
                <p>üéì Los retos est√°n ordenados por dificultad: F√°cil, Medio y Dif√≠cil.</p>
                <p>‚≠ê Completa el objetivo para marcar el reto como completado.</p>
                <p>üí° ¬°Practica y mejora tus habilidades de programaci√≥n!</p>
            </div>
            
            <div class="challenges-grid" id="challengesGrid">
            </div>
        </div>
    </div>

    <script>
        const PASTEL_COLORS = {
            red: '#FFB3BA',
            blue: '#BAE1FF',
            green: '#BAFFC9',
            yellow: '#FFFFBA',
            purple: '#E0BBE4',
            orange: '#FFD8B8'
        };

        const state = {
            running: false,
            stepMode: false,
            stepIndex: 0,
            draggingRobot: false,
            constructionMode: false,
            currentTool: null,
            currentChallenge: null,
            completedChallenges: new Set(),
            isPainting: false,
            paintColor: 'red',
            flatProgram: []
        };
        
        const robot = {
            canvas: null,
            ctx: null,
            x: 12,
            y: 7,
            direction: 0,
            gridWidth: 25,
            gridHeight: 15,
            cellSize: 40,
            trail: new Map(),
            walls: new Map(),
            startPoint: {x: 12, y: 7},
            goalPoint: null
        };
        
        const workspace = document.getElementById('workspace');
        
        function initCanvas() {
            robot.canvas = document.getElementById('robotCanvas');
            robot.canvas.width = robot.gridWidth * robot.cellSize;
            robot.canvas.height = robot.gridHeight * robot.cellSize;
            robot.ctx = robot.canvas.getContext('2d');
            redrawAll();
        }
        
        function redrawAll() {
            const ctx = robot.ctx;
            ctx.clearRect(0, 0, robot.canvas.width, robot.canvas.height);
            
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= robot.gridWidth; i++) {
                ctx.beginPath();
                ctx.moveTo(i * robot.cellSize, 0);
                ctx.lineTo(i * robot.cellSize, robot.canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i <= robot.gridHeight; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * robot.cellSize);
                ctx.lineTo(robot.canvas.width, i * robot.cellSize);
                ctx.stroke();
            }
            
            robot.trail.forEach((color, pos) => {
                const [x, y] = pos.split(',').map(Number);
                ctx.fillStyle = PASTEL_COLORS[color] || color;
                ctx.fillRect(x * robot.cellSize + 2, y * robot.cellSize + 2, 
                           robot.cellSize - 4, robot.cellSize - 4);
            });
            
            robot.walls.forEach((color, pos) => {
                const [x, y] = pos.split(',').map(Number);
                ctx.fillStyle = color;
                ctx.fillRect(x * robot.cellSize, y * robot.cellSize, 
                           robot.cellSize, robot.cellSize);
            });
            
            if (robot.startPoint) {
                ctx.fillStyle = 'rgba(76, 175, 80, 0.3)';
                ctx.fillRect(robot.startPoint.x * robot.cellSize, robot.startPoint.y * robot.cellSize,
                           robot.cellSize, robot.cellSize);
                ctx.fillStyle = '#4CAF50';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('S', robot.startPoint.x * robot.cellSize + robot.cellSize/2,
                           robot.startPoint.y * robot.cellSize + robot.cellSize/2);
            }
            
            if (robot.goalPoint) {
                ctx.fillStyle = 'rgba(255, 152, 0, 0.3)';
                ctx.fillRect(robot.goalPoint.x * robot.cellSize, robot.goalPoint.y * robot.cellSize,
                           robot.cellSize, robot.cellSize);
                ctx.fillStyle = '#FF9800';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('M', robot.goalPoint.x * robot.cellSize + robot.cellSize/2,
                           robot.goalPoint.y * robot.cellSize + robot.cellSize/2);
            }
            
            if (state.currentChallenge && state.currentChallenge.setup.targetImage) {
                ctx.strokeStyle = '#2196F3';
                ctx.lineWidth = 3;
                ctx.setLineDash([5, 5]);
                state.currentChallenge.setup.targetImage.forEach(pos => {
                    const [x, y] = pos.split(',').map(Number);
                    ctx.strokeRect(x * robot.cellSize + 2, y * robot.cellSize + 2, 
                                 robot.cellSize - 4, robot.cellSize - 4);
                });
                ctx.setLineDash([]);
            }
            
            const centerX = robot.x * robot.cellSize + robot.cellSize / 2;
            const centerY = robot.y * robot.cellSize + robot.cellSize / 2;
            const size = robot.cellSize * 0.6;
            
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate((robot.direction * 90) * Math.PI / 180);
            
            ctx.fillStyle = '#2196F3';
            ctx.beginPath();
            ctx.arc(0, 0, size/2, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.moveTo(0, -size/3);
            ctx.lineTo(-size/4, size/6);
            ctx.lineTo(size/4, size/6);
            ctx.closePath();
            ctx.fill();
            
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.moveTo(0, -size/3);
            ctx.lineTo(-size/8, -size/12);
            ctx.lineTo(size/8, -size/12);
            ctx.closePath();
            ctx.fill();
            
            ctx.restore();
        }
        
        document.querySelectorAll('.block-palette').forEach(block => {
            block.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('blockType', e.target.dataset.type);
            });
        });
        
        workspace.addEventListener('dragover', (e) => {
            e.preventDefault();
        });
        
        workspace.addEventListener('drop', (e) => {
            e.preventDefault();
            const blockType = e.dataTransfer.getData('blockType');
            addBlock(blockType);
            
            setTimeout(() => {
                workspace.scrollTop = workspace.scrollHeight;
            }, 100);
        });
        
        function addBlock(type) {
            const block = document.createElement('div');
            block.className = 'block-assembled';
            block.draggable = true;
            
            const colorClass = type.includes('AVANZAR') || type.includes('RETROCEDER') ? 'block-move' :
                             type.includes('GIRAR') ? 'block-turn' :
                             type.includes('PINTAR') ? 'block-paint' :
                             type.includes('FIN_') ? 'block-end' :
                             type === 'SI' ? 'block-conditional' : 'block-control';
            
            block.classList.add(colorClass);
            block.dataset.type = type;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'block-delete';
            deleteBtn.textContent = '√ó';
            deleteBtn.onclick = () => block.remove();
            
            switch(type) {
                case 'AVANZAR':
                    block.innerHTML = '‚¨ÜÔ∏è AVANZAR <input type="number" class="block-input" value="1" min="1" max="20">';
                    break;
                case 'RETROCEDER':
                    block.innerHTML = '‚¨áÔ∏è RETROCEDER <input type="number" class="block-input" value="1" min="1" max="20">';
                    break;
                case 'GIRAR_DERECHA':
                    block.innerHTML = '‚Ü± GIRAR DERECHA <input type="number" class="block-input" value="1" min="1" max="4"> veces';
                    break;
                case 'GIRAR_IZQUIERDA':
                    block.innerHTML = '‚Ü∞ GIRAR IZQUIERDA <input type="number" class="block-input" value="1" min="1" max="4"> veces';
                    break;
                case 'PINTAR':
                    block.innerHTML = 'üé® PINTAR <select class="block-select"><option value="red">Rojo</option><option value="blue">Azul</option><option value="green">Verde</option><option value="yellow">Amarillo</option><option value="purple">P√∫rpura</option><option value="orange">Naranja</option></select>';
                    break;
                case 'NO_PINTAR':
                    block.innerHTML = 'üö´ NO PINTAR';
                    break;
                case 'REPETIR':
                    block.innerHTML = 'üîÅ REPETIR <input type="number" class="block-input" value="2" min="1" max="20"> veces';
                    break;
                case 'FIN_REPETIR':
                    block.innerHTML = 'üîö FIN REPETIR';
                    break;
                case 'SI':
                    block.innerHTML = `
                        ‚ùì SI 
                        <select class="block-select">
                            <option value="HAY_MURO">Hay muro adelante</option>
                            <option value="NO_HAY_MURO">No hay muro adelante</option>
                            <option value="EN_META">Estoy en la meta</option>
                            <option value="NO_EN_META">No estoy en la meta</option>
                        </select>
                    `;
                    break;
                case 'FIN_SI':
                    block.innerHTML = 'üîö FIN SI';
                    break;
            }
            
            block.appendChild(deleteBtn);
            workspace.appendChild(block);
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
            
            block.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.innerHTML);
                e.target.style.opacity = '0.5';
            });
            
            block.addEventListener('dragend', (e) => {
                e.target.style.opacity = '1';
            });
            
            return block;
        }
        
        function buildFlatProgram() {
            const blocks = Array.from(workspace.children).filter(el => 
                el.classList.contains('block-assembled')
            );
            
            const flat = [];
            let indentLevel = 0;
            
            blocks.forEach(block => block.classList.remove('indent-1', 'indent-2', 'indent-3'));
            
            for (let i = 0; i < blocks.length; i++) {
                const block = blocks[i];
                const type = block.dataset.type;
                
                if (type === 'FIN_REPETIR' || type === 'FIN_SI') {
                    indentLevel = Math.max(0, indentLevel - 1);
                }
                
                if (indentLevel > 0) {
                    block.classList.add(`indent-${Math.min(indentLevel, 3)}`);
                }
                
                const instruction = {
                    block: block,
                    type: type,
                    indent: indentLevel,
                    index: i
                };
                
                if (type === 'AVANZAR' || type === 'RETROCEDER') {
                    instruction.steps = parseInt(block.querySelector('.block-input').value);
                } else if (type === 'REPETIR') {
                    instruction.times = parseInt(block.querySelector('.block-input').value);
                } else if (type === 'SI') {
                    instruction.condition = block.querySelector('.block-select').value;
                } else if (type === 'PINTAR') {
                    instruction.color = block.querySelector('.block-select').value;
                }
                
                flat.push(instruction);
                
                if (type === 'REPETIR' || type === 'SI') {
                    indentLevel++;
                }
            }
            
            return flat;
        }
        
        async function runProgram() {
            if (state.running) return;
            
            state.running = true;
            state.stepMode = false;
            state.isPainting = false;
            
            const speed = 11 - parseInt(document.getElementById('speedSlider').value);
            const delay = speed * 100;
            
            log('');
            
            try {
                robot.x = robot.startPoint.x;
                robot.y = robot.startPoint.y;
                robot.direction = 0;
                robot.trail.clear();
                state.flatProgram = buildFlatProgram();
                await executeProgram(delay);
                
                log('');
                
                if (robot.goalPoint) {
                    if (robot.x === robot.goalPoint.x && robot.y === robot.goalPoint.y) {
                        showMessage('¬°LOGRADO!', true);
                        if (state.currentChallenge) {
                            state.completedChallenges.add(state.currentChallenge.id);
                            localStorage.setItem('completedChallenges', 
                                JSON.stringify(Array.from(state.completedChallenges)));
                            setTimeout(() => {
                                if (confirm(`¬°Felicidades! ¬øQuieres intentar el siguiente reto?`)) {
                                    const nextChallenge = challenges.find(c => 
                                        c.id === state.currentChallenge.id + 1
                                    );
                                    if (nextChallenge) {
                                        loadChallenge(nextChallenge);
                                    } else {
                                        alert('¬°Has completado todos los retos! üèÜ');
                                    }
                                }
                            }, 2500);
                        }
                    } else {
                        showMessage('ERROR', false);
                    }
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
            
            state.running = false;
            state.flatProgram.forEach(inst => inst.block.classList.remove('executing'));
        }
        
        async function executeProgram(delay) {
            let i = 0;
            
            while (i < state.flatProgram.length && state.running) {
                const instruction = state.flatProgram[i];
                
                state.flatProgram.forEach(inst => inst.block.classList.remove('executing'));
                instruction.block.classList.add('executing');
                
                await sleep(delay);
                
                const result = await executeInstruction(instruction, delay);
                
                if (result && result.jump !== undefined) {
                    i = result.jump;
                } else {
                    i++;
                }
            }
        }
        
        function stepProgram() {
            if (state.running) return;
            
            state.stepMode = true;
            state.stepIndex = 0;
            state.running = true;
            state.isPainting = false;
            
            state.flatProgram = buildFlatProgram();
            
            document.getElementById('nextStepBtn').disabled = false;
            log('');
            
            if (state.flatProgram.length > 0) {
                state.flatProgram[0].block.classList.add('executing');
            }
        }
        
        async function nextStep() {
            if (!state.stepMode || state.stepIndex >= state.flatProgram.length) {
                state.running = false;
                state.stepMode = false;
                document.getElementById('nextStepBtn').disabled = true;
                state.flatProgram.forEach(inst => inst.block.classList.remove('executing'));
                log('');
                
                if (state.currentChallenge) {
                    checkChallengeCompletion();
                }
                return;
            }
            
            const instruction = state.flatProgram[state.stepIndex];
            
            try {
                const result = await executeInstruction(instruction, 0);
                
                state.flatProgram.forEach(inst => inst.block.classList.remove('executing'));
                
                if (result && result.jump !== undefined) {
                    state.stepIndex = result.jump;
                } else {
                    state.stepIndex++;
                }
                
                if (state.stepIndex < state.flatProgram.length) {
                    state.flatProgram[state.stepIndex].block.classList.add('executing');
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message);
                state.running = false;
                state.stepMode = false;
                document.getElementById('nextStepBtn').disabled = true;
                state.flatProgram.forEach(inst => inst.block.classList.remove('executing'));
            }
        }
        
        async function executeInstruction(instruction, delay) {
            const type = instruction.type;
            
            switch(type) {
                case 'AVANZAR': {
                    for (let i = 0; i < instruction.steps; i++) {
                        await moveForward();
                        if (state.isPainting) {
                            robot.trail.set(`${robot.x},${robot.y}`, state.paintColor);
                        }
                        redrawAll();
                        await sleep(delay);
                    }
                    break;
                }
                case 'RETROCEDER': {
                    for (let i = 0; i < instruction.steps; i++) {
                        await moveBackward();
                        if (state.isPainting) {
                            robot.trail.set(`${robot.x},${robot.y}`, state.paintColor);
                        }
                        redrawAll();
                        await sleep(delay);
                    }
                    break;
                }
                case 'GIRAR_DERECHA': {
                    const times = parseInt(instruction.block.querySelector('.block-input')?.value || 1);
                    robot.direction = (robot.direction + times) % 4;
                    redrawAll();
                    break;
                }
                case 'GIRAR_IZQUIERDA': {
                    const times = parseInt(instruction.block.querySelector('.block-input')?.value || 1);
                    robot.direction = (robot.direction + 4 - (times % 4)) % 4;
                    redrawAll();
                    break;
                }
                case 'PINTAR':
                    state.isPainting = true;
                    state.paintColor = instruction.color;
                    robot.trail.set(`${robot.x},${robot.y}`, instruction.color);
                    redrawAll();
                    log(`üé® Pintura activada (${instruction.color})`);
                    break;
                case 'NO_PINTAR':
                    state.isPainting = false;
                    log('üö´ Pintura desactivada');
                    break;
                case 'REPETIR': {
                    const finIndex = findMatchingEnd(instruction.index, 'FIN_REPETIR');
                    if (finIndex === -1) {
                        throw new Error('REPETIR sin FIN_REPETIR');
                    }
                    
                    if (!instruction.loopCount) {
                        instruction.loopCount = 0;
                    }
                    
                    instruction.loopCount++;
                    
                    if (instruction.loopCount > instruction.times) {
                        instruction.loopCount = 0;
                        return {jump: finIndex + 1};
                    }
                    break;
                }
                case 'FIN_REPETIR': {
                    const repetirIndex = findMatchingStart(instruction.index, 'REPETIR');
                    if (repetirIndex !== -1) {
                        return {jump: repetirIndex};
                    }
                    break;
                }
                case 'SI': {
                    const conditionMet = evaluateCondition(instruction.condition);
                    
                    if (!conditionMet) {
                        const finIndex = findMatchingEnd(instruction.index, 'FIN_SI');
                        if (finIndex !== -1) {
                            return {jump: finIndex + 1};
                        }
                    }
                    break;
                }
                case 'FIN_SI':
                    break;
            }
            
            return null;
        }
        
        function findMatchingEnd(startIndex, endType) {
            const startType = state.flatProgram[startIndex].type;
            let depth = 1;
            
            for (let i = startIndex + 1; i < state.flatProgram.length; i++) {
                const type = state.flatProgram[i].type;
                
                if (type === startType) {
                    depth++;
                } else if (type === endType) {
                    depth--;
                    if (depth === 0) {
                        return i;
                    }
                }
            }
            
            return -1;
        }
        
        function findMatchingStart(endIndex, startType) {
            const endType = state.flatProgram[endIndex].type;
            let depth = 1;
            
            for (let i = endIndex - 1; i >= 0; i--) {
                const type = state.flatProgram[i].type;
                
                if (type === endType) {
                    depth++;
                } else if (type === startType) {
                    depth--;
                    if (depth === 0) {
                        return i;
                    }
                }
            }
            
            return -1;
        }
        
        function evaluateCondition(condition) {
            switch(condition) {
                case 'HAY_MURO': {
                    const [nextX, nextY] = getNextPosition();
                    return robot.walls.has(`${nextX},${nextY}`) || 
                           nextX < 0 || nextX >= robot.gridWidth || 
                           nextY < 0 || nextY >= robot.gridHeight;
                }
                case 'NO_HAY_MURO': {
                    const [nextX, nextY] = getNextPosition();
                    return !robot.walls.has(`${nextX},${nextY}`) && 
                           nextX >= 0 && nextX < robot.gridWidth && 
                           nextY >= 0 && nextY < robot.gridHeight;
                }
                case 'EN_META':
                    return robot.goalPoint && 
                           robot.x === robot.goalPoint.x && 
                           robot.y === robot.goalPoint.y;
                case 'NO_EN_META':
                    return !robot.goalPoint || 
                           robot.x !== robot.goalPoint.x || 
                           robot.y !== robot.goalPoint.y;
                default:
                    return false;
            }
        }
        
        function getNextPosition() {
            const directions = [[0, -1], [1, 0], [0, 1], [-1, 0]];
            const [dx, dy] = directions[robot.direction];
            return [robot.x + dx, robot.y + dy];
        }
        
        async function moveForward() {
            const [nextX, nextY] = getNextPosition();
            
            if (nextX < 0 || nextX >= robot.gridWidth || nextY < 0 || nextY >= robot.gridHeight) {
                throw new Error('Fuera del mapa');
            }
            
            if (robot.walls.has(`${nextX},${nextY}`)) {
                throw new Error('¬°Choc√≥ con un muro!');
            }
            
            robot.x = nextX;
            robot.y = nextY;
        }
        
        async function moveBackward() {
            const directions = [[0, -1], [1, 0], [0, 1], [-1, 0]];
            const [dx, dy] = directions[robot.direction];
            const nextX = robot.x - dx;
            const nextY = robot.y - dy;
            
            if (nextX < 0 || nextX >= robot.gridWidth || nextY < 0 || nextY >= robot.gridHeight) {
                throw new Error('Fuera del mapa');
            }
            
            if (robot.walls.has(`${nextX},${nextY}`)) {
                throw new Error('¬°Choc√≥ con un muro!');
            }
            
            robot.x = nextX;
            robot.y = nextY;
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function resetRobot() {
            robot.x = robot.startPoint.x;
            robot.y = robot.startPoint.y;
            robot.direction = 0;
            robot.trail.clear();
            state.running = false;
            state.stepMode = false;
            state.stepIndex = 0;
            state.isPainting = false;
            document.getElementById('nextStepBtn').disabled = true;
            
            const blocks = Array.from(workspace.children).filter(el => 
                el.classList.contains('block-assembled')
            );
            blocks.forEach(block => {
                block.classList.remove('executing');
                if (block.dataset.type === 'REPETIR') {
                    const instruction = state.flatProgram.find(inst => inst.block === block);
                    if (instruction) instruction.loopCount = 0;
                }
            });
            
            redrawAll();
            log('üîÑ Robot reiniciado');
        }
        
        function clearProgram() {
            if (confirm('‚ö†Ô∏è Esto borrar√° todos los bloques y devolver√° el robot al punto de inicio. ¬øContinuar?')) {
                workspace.innerHTML = '<div class="assembly-title">üìù MI PROGRAMA</div>';
                resetRobot();
                log('');
            }
        }
        
        function toggleConstruction() {
            state.constructionMode = !state.constructionMode;
            const tools = document.getElementById('constructionTools');
            tools.style.display = state.constructionMode ? 'flex' : 'none';
            log(state.constructionMode ? 'üèóÔ∏è Modo construcci√≥n ON' : 'üèóÔ∏è Modo construcci√≥n OFF');
        }
        
        function setTool(tool) {
            state.currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function clearMap() {
            if (confirm('¬øBorrar todos los muros?')) {
                robot.walls.clear();
                redrawAll();
                log('üóë Mapa limpiado');
            }
        }
        
        function saveProject() {
            const project = {
                blocks: workspace.innerHTML,
                walls: Array.from(robot.walls.entries()),
                startPoint: robot.startPoint,
                goalPoint: robot.goalPoint,
                robotPosition: {x: robot.x, y: robot.y, direction: robot.direction}
            };
            
            const blob = new Blob([JSON.stringify(project, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `robot-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            log('üíæ Proyecto guardado');
        }
        
        function loadProject(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const project = JSON.parse(e.target.result);
                    workspace.innerHTML = project.blocks;
                    robot.walls.clear();
                    if (project.walls) {
                        project.walls.forEach(([key, color]) => robot.walls.set(key, color));
                    }
                    if (project.startPoint) {
                        robot.startPoint = project.startPoint;
                        robot.x = project.startPoint.x;
                        robot.y = project.startPoint.y;
                    }
                    if (project.goalPoint) robot.goalPoint = project.goalPoint;
                    if (project.robotPosition) robot.direction = project.robotPosition.direction || 0;
                    redrawAll();
                    log('üìÇ Proyecto cargado');
                } catch (error) {
                    log('‚ùå Error al cargar');
                }
            };
            reader.readAsText(file);
        }
        
        function loadMap(select) {
            const mapId = select.value;
            if (!mapId) return;
            
            const maps = {
                map1: {
                    name: "L√≠nea Recta",
                    walls: [],
                    start: {x: 2, y: 7},
                    goal: {x: 22, y: 7}
                },
                map2: {
                    name: "Esquina Simple",
                    walls: ["12,5", "12,6", "12,7", "12,8", "12,9"],
                    start: {x: 5, y: 7},
                    goal: {x: 20, y: 7}
                },
                map3: {
                    name: "Zigzag",
                    walls: ["8,9", "8,8", "8,7", "17,7", "17,6", "17,5"],
                    start: {x: 3, y: 10},
                    goal: {x: 22, y: 4}
                },
                map4: {
                    name: "Corredor",
                    walls: [
                        "10,5", "10,6", "10,7", "10,8", "10,9", "10,10",
                        "15,5", "15,6", "15,7", "15,8", "15,9", "15,10"
                    ],
                    start: {x: 12, y: 4},
                    goal: {x: 12, y: 11}
                },
                map5: {
                    name: "L Simple",
                    walls: ["12,6", "12,7", "12,8", "12,9", "13,9", "14,9"],
                    start: {x: 8, y: 6},
                    goal: {x: 18, y: 9}
                }
            };
            
            const map = maps[mapId];
            if (!map) return;
            
            robot.walls.clear();
            robot.trail.clear();
            workspace.innerHTML = '<div class="assembly-title">üìù MI PROGRAMA</div>';
            
            map.walls.forEach(pos => robot.walls.set(pos, '#808080'));
            robot.startPoint = map.start;
            robot.x = map.start.x;
            robot.y = map.start.y;
            robot.direction = 0;
            robot.goalPoint = map.goal;
            
            redrawAll();
            log(`üó∫Ô∏è ${map.name} cargado`);
            select.selectedIndex = 0;
        }
        
        function loadExample(type) {
            workspace.innerHTML = '<div class="assembly-title">üìù MI PROGRAMA</div>';
            if (type === 'cuadrado') {
                const repetir = addBlock('REPETIR');
                repetir.querySelector('.block-input').value = 4;
                const avanzar = addBlock('AVANZAR');
                avanzar.querySelector('.block-input').value = 3;
                const girar = addBlock('GIRAR_DERECHA');
                const finRepetir = addBlock('FIN_REPETIR');
                log('üìö Ejemplo: Cuadrado');
            } else if (type === 'linea') {
                const pintar = addBlock('PINTAR');
                const avanzar = addBlock('AVANZAR');
                avanzar.querySelector('.block-input').value = 5;
                const noPintar = addBlock('NO_PINTAR');
                log('üìö Ejemplo: L√≠nea');
            }
        }
        
        const challenges = [
            {
                id: 1,
                name: "Camino Recto",
                difficulty: "F√°cil",
                description: "Llega a la meta avanzando",
                setup: {
                    walls: [],
                    start: {x: 10, y: 7},
                    goal: {x: 14, y: 7}
                },
                checkSuccess: () => robot.x === 14 && robot.y === 7
            },
            {
                id: 2,
                name: "Esquina Simple",
                difficulty: "F√°cil",
                description: "Gira y llega a la meta",
                setup: {
                    walls: ["12,6", "13,6", "14,6"],
                    start: {x: 10, y: 7},
                    goal: {x: 14, y: 4}
                },
                checkSuccess: () => robot.x === 14 && robot.y === 4
            },
            {
                id: 3,
                name: "Muro Central",
                difficulty: "F√°cil",
                description: "Rodea el muro para llegar",
                setup: {
                    walls: ["12,7", "12,6", "12,5"],
                    start: {x: 10, y: 7},
                    goal: {x: 15, y: 7}
                },
                checkSuccess: () => robot.x === 15 && robot.y === 7
            },
            {
                id: 4,
                name: "Pasillo en L",
                difficulty: "Medio",
                description: "Navega el pasillo hasta la meta",
                setup: {
                    walls: ["10,5", "11,5", "12,5", "13,5", "13,6", "13,7", "13,8", "13,9"],
                    start: {x: 10, y: 7},
                    goal: {x: 16, y: 7}
                },
                checkSuccess: () => robot.x === 16 && robot.y === 7
            },
            {
                id: 5,
                name: "Zigzag",
                difficulty: "Medio",
                description: "Cruza el zigzag hasta la meta",
                setup: {
                    walls: ["11,5", "11,6", "13,7", "13,8", "15,5", "15,6"],
                    start: {x: 9, y: 7},
                    goal: {x: 17, y: 7}
                },
                checkSuccess: () => robot.x === 17 && robot.y === 7
            },
            {
                id: 6,
                name: "Corredor Estrecho",
                difficulty: "Medio",
                description: "Pasa por el corredor",
                setup: {
                    walls: ["11,5", "11,6", "11,7", "11,8", "11,9", "15,5", "15,6", "15,7", "15,8", "15,9"],
                    start: {x: 9, y: 7},
                    goal: {x: 17, y: 7}
                },
                checkSuccess: () => robot.x === 17 && robot.y === 7
            },
            {
                id: 7,
                name: "Laberinto Mini",
                difficulty: "Medio",
                description: "Encuentra el camino",
                setup: {
                    walls: ["10,5", "11,5", "12,5", "13,5", "11,7", "12,7", "13,7", "11,9", "12,9", "13,9"],
                    start: {x: 10, y: 7},
                    goal: {x: 13, y: 11}
                },
                checkSuccess: () => robot.x === 13 && robot.y === 11
            },
            {
                id: 8,
                name: "Espiral Simple",
                difficulty: "Dif√≠cil",
                description: "Llega al centro de la espiral",
                setup: {
                    walls: ["9,5", "10,5", "11,5", "12,5", "13,5", "14,5", "14,6", "14,7", "14,8", "14,9", "9,9", "10,9", "11,9", "12,9", "13,9", "9,6", "9,7", "9,8", "11,7", "12,7"],
                    start: {x: 10, y: 7},
                    goal: {x: 12, y: 6}
                },
                checkSuccess: () => robot.x === 12 && robot.y === 6
            },
            {
                id: 9,
                name: "Doble Barrera",
                difficulty: "Medio",
                description: "Cruza ambas barreras",
                setup: {
                    walls: ["11,5", "11,6", "11,7", "15,7", "15,8", "15,9"],
                    start: {x: 9, y: 7},
                    goal: {x: 18, y: 7}
                },
                checkSuccess: () => robot.x === 18 && robot.y === 7
            },
            {
                id: 10,
                name: "Escalera",
                difficulty: "Medio",
                description: "Sube la escalera",
                setup: {
                    walls: ["11,8", "12,7", "13,6", "14,5"],
                    start: {x: 10, y: 9},
                    goal: {x: 15, y: 4}
                },
                checkSuccess: () => robot.x === 15 && robot.y === 4
            },
            {
                id: 11,
                name: "Cruz de Muros",
                difficulty: "Dif√≠cil",
                description: "Rodea la cruz",
                setup: {
                    walls: ["12,5", "12,6", "12,7", "12,8", "12,9", "10,7", "11,7", "13,7", "14,7"],
                    start: {x: 10, y: 5},
                    goal: {x: 14, y: 9}
                },
                checkSuccess: () => robot.x === 14 && robot.y === 9
            },
            {
                id: 12,
                name: "T√∫nel en U",
                difficulty: "Dif√≠cil",
                description: "Atraviesa el t√∫nel",
                setup: {
                    walls: ["10,5", "11,5", "12,5", "13,5", "14,5", "10,9", "11,9", "12,9", "13,9", "14,9", "10,6", "10,7", "10,8"],
                    start: {x: 11, y: 7},
                    goal: {x: 15, y: 7}
                },
                checkSuccess: () => robot.x === 15 && robot.y === 7
            },
            {
                id: 13,
                name: "Laberinto T",
                difficulty: "Dif√≠cil",
                description: "Navega la T",
                setup: {
                    walls: ["10,6", "11,6", "12,6", "13,6", "14,6", "12,7", "12,8", "12,9", "12,10"],
                    start: {x: 12, y: 5},
                    goal: {x: 16, y: 8}
                },
                checkSuccess: () => robot.x === 16 && robot.y === 8
            },
            {
                id: 14,
                name: "Camino Bloqueado",
                difficulty: "Dif√≠cil",
                description: "Encuentra el camino alternativo",
                setup: {
                    walls: ["11,6", "12,6", "13,6", "14,6", "15,6", "11,8", "12,8", "13,8", "14,8", "15,8", "13,7"],
                    start: {x: 10, y: 7},
                    goal: {x: 17, y: 7}
                },
                checkSuccess: () => robot.x === 17 && robot.y === 7
            },
            {
                id: 15,
                name: "Laberinto Maestro",
                difficulty: "Muy Dif√≠cil",
                description: "Resuelve el laberinto completo",
                setup: {
                    walls: ["8,4", "9,4", "10,4", "11,4", "12,4", "13,4", "14,4", "15,4", "16,4", "8,10", "9,10", "10,10", "11,10", "12,10", "13,10", "14,10", "15,10", "16,10", "8,5", "8,6", "8,7", "8,8", "8,9", "16,5", "16,6", "16,7", "16,8", "16,9", "10,6", "11,6", "13,6", "14,6", "10,8", "11,8", "13,8", "14,8"],
                    start: {x: 9, y: 7},
                    goal: {x: 15, y: 7}
                },
                checkSuccess: () => robot.x === 15 && robot.y === 7
            },
            {
                id: 16,
                name: "L√≠nea Horizontal",
                difficulty: "F√°cil",
                description: "Pinta una l√≠nea horizontal",
                setup: {
                    walls: [],
                    start: {x: 10, y: 7},
                    goal: null,
                    targetImage: ["10,7", "11,7", "12,7", "13,7", "14,7"]
                },
                checkSuccess: () => {
                    const target = ["10,7", "11,7", "12,7", "13,7", "14,7"];
                    return target.every(pos => robot.trail.has(pos)) && robot.trail.size === target.length;
                }
            },
            {
                id: 17,
                name: "L√≠nea Vertical",
                difficulty: "F√°cil",
                description: "Pinta una l√≠nea vertical",
                setup: {
                    walls: [],
                    start: {x: 12, y: 5},
                    goal: null,
                    targetImage: ["12,5", "12,6", "12,7", "12,8", "12,9"]
                },
                checkSuccess: () => {
                    const target = ["12,5", "12,6", "12,7", "12,8", "12,9"];
                    return target.every(pos => robot.trail.has(pos)) && robot.trail.size === target.length;
                }
            },
            {
                id: 18,
                name: "Cuadrado 3x3",
                difficulty: "F√°cil",
                description: "Dibuja un cuadrado",
                setup: {
                    walls: [],
                    start: {x: 10, y: 10},
                    goal: null,
                    targetImage: ["10,10", "11,10", "12,10", "12,9", "12,8", "11,8", "10,8", "10,9"]
                },
                checkSuccess: () => {
                    const target = ["10,10", "11,10", "12,10", "12,9", "12,8", "11,8", "10,8", "10,9"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 19,
                name: "Cruz",
                difficulty: "Medio",
                description: "Dibuja una cruz",
                setup: {
                    walls: [],
                    start: {x: 12, y: 5},
                    goal: null,
                    targetImage: ["12,5", "12,6", "12,7", "12,8", "12,9", "10,7", "11,7", "13,7", "14,7"]
                },
                checkSuccess: () => {
                    const target = ["12,5", "12,6", "12,7", "12,8", "12,9", "10,7", "11,7", "13,7", "14,7"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 20,
                name: "L Grande",
                difficulty: "Medio",
                description: "Dibuja una L",
                setup: {
                    walls: [],
                    start: {x: 10, y: 5},
                    goal: null,
                    targetImage: ["10,5", "10,6", "10,7", "10,8", "10,9", "11,9", "12,9", "13,9"]
                },
                checkSuccess: () => {
                    const target = ["10,5", "10,6", "10,7", "10,8", "10,9", "11,9", "12,9", "13,9"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 21,
                name: "Escalera Pintada",
                difficulty: "Medio",
                description: "Dibuja escaleras",
                setup: {
                    walls: [],
                    start: {x: 10, y: 9},
                    goal: null,
                    targetImage: ["10,9", "11,9", "11,8", "12,8", "12,7", "13,7", "13,6", "14,6"]
                },
                checkSuccess: () => {
                    const target = ["10,9", "11,9", "11,8", "12,8", "12,7", "13,7", "13,6", "14,6"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 22,
                name: "T Invertida",
                difficulty: "Medio",
                description: "Dibuja una T",
                setup: {
                    walls: [],
                    start: {x: 10, y: 6},
                    goal: null,
                    targetImage: ["10,6", "11,6", "12,6", "13,6", "14,6", "12,7", "12,8", "12,9"]
                },
                checkSuccess: () => {
                    const target = ["10,6", "11,6", "12,6", "13,6", "14,6", "12,7", "12,8", "12,9"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 23,
                name: "Zigzag Pintado",
                difficulty: "Medio",
                description: "Dibuja un zigzag",
                setup: {
                    walls: [],
                    start: {x: 10, y: 7},
                    goal: null,
                    targetImage: ["10,7", "11,7", "12,7", "12,6", "13,6", "14,6", "14,7", "15,7"]
                },
                checkSuccess: () => {
                    const target = ["10,7", "11,7", "12,7", "12,6", "13,6", "14,6", "14,7", "15,7"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 24,
                name: "Doble L",
                difficulty: "Dif√≠cil",
                description: "Dibuja dos L conectadas",
                setup: {
                    walls: [],
                    start: {x: 10, y: 6},
                    goal: null,
                    targetImage: ["10,6", "10,7", "10,8", "11,8", "12,8", "12,7", "12,6", "13,6", "14,6"]
                },
                checkSuccess: () => {
                    const target = ["10,6", "10,7", "10,8", "11,8", "12,8", "12,7", "12,6", "13,6", "14,6"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 25,
                name: "Rect√°ngulo",
                difficulty: "Medio",
                description: "Dibuja un rect√°ngulo 5x3",
                setup: {
                    walls: [],
                    start: {x: 10, y: 10},
                    goal: null,
                    targetImage: ["10,10", "11,10", "12,10", "13,10", "14,10", "14,9", "14,8", "13,8", "12,8", "11,8", "10,8", "10,9"]
                },
                checkSuccess: () => {
                    const target = ["10,10", "11,10", "12,10", "13,10", "14,10", "14,9", "14,8", "13,8", "12,8", "11,8", "10,8", "10,9"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 26,
                name: "Espiral Cuadrada",
                difficulty: "Dif√≠cil",
                description: "Dibuja una espiral",
                setup: {
                    walls: [],
                    start: {x: 10, y: 10},
                    goal: null,
                    targetImage: ["10,10", "11,10", "12,10", "13,10", "13,9", "13,8", "13,7", "12,7", "11,7", "10,7", "10,8", "10,9", "11,9", "12,9", "12,8"]
                },
                checkSuccess: () => {
                    const target = ["10,10", "11,10", "12,10", "13,10", "13,9", "13,8", "13,7", "12,7", "11,7", "10,7", "10,8", "10,9", "11,9", "12,9", "12,8"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 27,
                name: "Letra E",
                difficulty: "Dif√≠cil",
                description: "Dibuja la letra E",
                setup: {
                    walls: [],
                    start: {x: 10, y: 6},
                    goal: null,
                    targetImage: ["10,6", "10,7", "10,8", "10,9", "10,10", "11,6", "12,6", "11,8", "12,8", "11,10", "12,10"]
                },
                checkSuccess: () => {
                    const target = ["10,6", "10,7", "10,8", "10,9", "10,10", "11,6", "12,6", "11,8", "12,8", "11,10", "12,10"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 28,
                name: "Letra H",
                difficulty: "Dif√≠cil",
                description: "Dibuja la letra H",
                setup: {
                    walls: [],
                    start: {x: 10, y: 6},
                    goal: null,
                    targetImage: ["10,6", "10,7", "10,8", "10,9", "10,10", "11,8", "12,8", "13,6", "13,7", "13,8", "13,9", "13,10"]
                },
                checkSuccess: () => {
                    const target = ["10,6", "10,7", "10,8", "10,9", "10,10", "11,8", "12,8", "13,6", "13,7", "13,8", "13,9", "13,10"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 29,
                name: "Casa Simple",
                difficulty: "Dif√≠cil",
                description: "Dibuja una casa",
                setup: {
                    walls: [],
                    start: {x: 10, y: 10},
                    goal: null,
                    targetImage: ["10,10", "10,9", "10,8", "11,8", "12,8", "13,8", "13,9", "13,10", "12,10", "11,10", "11,7", "12,7", "12,6"]
                },
                checkSuccess: () => {
                    const target = ["10,10", "10,9", "10,8", "11,8", "12,8", "13,8", "13,9", "13,10", "12,10", "11,10", "11,7", "12,7", "12,6"];
                    return target.every(pos => robot.trail.has(pos));
                }
            },
            {
                id: 30,
                name: "Diamante",
                difficulty: "Muy Dif√≠cil",
                description: "Dibuja un diamante perfecto",
                setup: {
                    walls: [],
                    start: {x: 12, y: 5},
                    goal: null,
                    targetImage: ["12,5", "11,6", "10,7", "11,8", "12,9", "13,8", "14,7", "13,6"]
                },
                checkSuccess: () => {
                    const target = ["12,5", "11,6", "10,7", "11,8", "12,9", "13,8", "14,7", "13,6"];
                    return target.every(pos => robot.trail.has(pos));
                }
            }
        ];
        
        function openChallengesModal() {
            const modal = document.getElementById('challengesModal');
            const grid = document.getElementById('challengesGrid');
            
            grid.innerHTML = '';
            
            challenges.forEach(challenge => {
                const card = document.createElement('div');
                card.className = 'challenge-card';
                if (state.completedChallenges.has(challenge.id)) {
                    card.classList.add('completed');
                }
                
                card.innerHTML = `
                    <h3>Reto ${challenge.id}: ${challenge.name}</h3>
                    <p>${challenge.description}</p>
                    <span class="challenge-difficulty">${challenge.difficulty}</span>
                `;
                
                card.onclick = () => loadChallenge(challenge);
                grid.appendChild(card);
            });
            
            modal.style.display = 'block';
        }
        
        function closeChallengesModal() {
            document.getElementById('challengesModal').style.display = 'none';
        }
        
        function loadChallenge(challenge) {
            closeChallengesModal();
            
            state.currentChallenge = challenge;
            
            workspace.innerHTML = '<div class="assembly-title">üìù MI PROGRAMA</div>';
            
            robot.walls.clear();
            robot.trail.clear();
            
            challenge.setup.walls.forEach(pos => robot.walls.set(pos, '#808080'));
            robot.startPoint = challenge.setup.start;
            robot.x = challenge.setup.start.x;
            robot.y = challenge.setup.start.y;
            robot.direction = 0;
            robot.goalPoint = challenge.setup.goal;
            
            redrawAll();
            
            log(`üéØ Reto ${challenge.id}: ${challenge.name}`);
            log(`üìù ${challenge.description}`);
        }
        
        function showMessage(message, isSuccess) {
            const overlay = document.getElementById('messageOverlay');
            overlay.textContent = message;
            overlay.className = 'message-overlay ' + (isSuccess ? 'success' : 'error');
            overlay.style.display = 'block';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 2000);
        }
        
        function checkChallengeCompletion() {
            if (!state.currentChallenge) return;
            
            if (state.currentChallenge.checkSuccess()) {
                state.completedChallenges.add(state.currentChallenge.id);
                showMessage('¬°LOGRADO!', true);
                
                localStorage.setItem('completedChallenges', 
                    JSON.stringify(Array.from(state.completedChallenges)));
                
                setTimeout(() => {
                    if (confirm(`¬°Felicidades! ¬øQuieres intentar el siguiente reto?`)) {
                        const nextChallenge = challenges.find(c => 
                            c.id === state.currentChallenge.id + 1
                        );
                        if (nextChallenge) {
                            loadChallenge(nextChallenge);
                        } else {
                            alert('¬°Has completado todos los retos! üèÜ');
                        }
                    }
                }, 500);
            } else {
                showMessage('ERROR', false);
            }
        }
        
        function setupCanvasEvents() {
            robot.canvas.addEventListener('mousedown', (e) => {
                const rect = robot.canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * (robot.canvas.width / rect.width);
                const y = (e.clientY - rect.top) * (robot.canvas.height / rect.height);
                const gridX = Math.floor(x / robot.cellSize);
                const gridY = Math.floor(y / robot.cellSize);
                
                if (state.constructionMode) {
                    handleConstruction(gridX, gridY);
                } else if (gridX === robot.x && gridY === robot.y) {
                    state.draggingRobot = true;
                }
            });
            
            robot.canvas.addEventListener('mousemove', (e) => {
                if (!state.draggingRobot && !state.constructionMode) return;
                
                const rect = robot.canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * (robot.canvas.width / rect.width);
                const y = (e.clientY - rect.top) * (robot.canvas.height / rect.height);
                const gridX = Math.floor(x / robot.cellSize);
                const gridY = Math.floor(y / robot.cellSize);
                
                if (state.constructionMode && e.buttons === 1) {
                    handleConstruction(gridX, gridY);
                } else if (state.draggingRobot) {
                    if (gridX >= 0 && gridX < robot.gridWidth && gridY >= 0 && gridY < robot.gridHeight && 
                        !robot.walls.has(`${gridX},${gridY}`)) {
                        robot.x = gridX;
                        robot.y = gridY;
                        robot.startPoint = {x: gridX, y: gridY};
                        redrawAll();
                    }
                }
            });
            
            robot.canvas.addEventListener('mouseup', () => {
                if (state.draggingRobot) {
                    state.draggingRobot = false;
                    log(`üìç Inicio: (${robot.x}, ${robot.y})`);
                }
            });
        }
        
        function handleConstruction(gridX, gridY) {
            if (gridX < 0 || gridX >= robot.gridWidth || gridY < 0 || gridY >= robot.gridHeight) return;
            
            const key = `${gridX},${gridY}`;
            
            if (state.currentTool === 'wall') {
                robot.walls.set(key, '#808080');
            } else if (state.currentTool === 'erase') {
                robot.walls.delete(key);
            } else if (state.currentTool === 'start') {
                robot.startPoint = {x: gridX, y: gridY};
                robot.x = gridX;
                robot.y = gridY;
                log(`üìç Inicio: (${gridX}, ${gridY})`);
            } else if (state.currentTool === 'goal') {
                robot.goalPoint = {x: gridX, y: gridY};
                log(`üéØ Meta: (${gridX}, ${gridY})`);
            }
            
            redrawAll();
        }
        
        function log(message) {
            const console = document.getElementById('console');
            console.innerHTML = '';
            const line = document.createElement('div');
            line.className = 'console-line';
            line.textContent = message;
            console.appendChild(line);
        }
        
        document.getElementById('speedSlider').addEventListener('input', (e) => {
            document.getElementById('speedValue').textContent = e.target.value;
        });
        
        window.onclick = function(event) {
            const modal = document.getElementById('challengesModal');
            if (event.target == modal) {
                closeChallengesModal();
            }
        }
        
        function loadCompletedChallenges() {
            const saved = localStorage.getItem('completedChallenges');
            if (saved) {
                state.completedChallenges = new Set(JSON.parse(saved));
            }
        }
        
        window.addEventListener('load', () => {
            initCanvas();
            setupCanvasEvents();
            loadCompletedChallenges();
        });
    </script>
    <div id="messageOverlay" class="message-overlay"></div>
</body>
</html>
